from __future__ import annotations

import uuid
from datetime import datetime
from enum import Enum
from typing import Any, Optional

from pydantic import BaseModel, Field


class TaskStatus(str, Enum):
    CONFIGURING = "configuring"
    PENDING = "pending"
    ACTIVE = "active"
    COMPLETE = "complete"
    PAUSED = "paused"
    FAILED = "failed"

    @classmethod
    def _missing_(cls, value: object):
        if isinstance(value, str):
            # Normalize to lowercase before lookup
            value = value.lower()
            for member in cls:
                if member.value == value:
                    return member
        return None


class Subtask(BaseModel):
    """Individual subtask in a research plan"""

    order: int
    description: str
    success_criteria: str
    status: str = "pending"  # pending, in_progress, completed
    findings: list[str] = Field(default_factory=list)


class ResearchPlan(BaseModel):
    """Research plan generated by the orchestrator"""

    restated_task: str
    subtasks: list[Subtask]
    current_subtask_index: int = 0
    created_at: int = Field(
        default_factory=lambda: int(datetime.now().timestamp() * 1000)
    )


class TaskMetrics(BaseModel):
    """Metrics for task execution"""

    searchCount: int = 0
    thinkCount: int = 0
    summaryCount: int = 0
    checkpointCount: int = 0
    webFetchCount: int = 0
    llmTokensUsed: int = 0
    errorCount: int = 0


class Task(BaseModel):
    """Main task model used across the system"""

    id: str = Field(default_factory=lambda: str(uuid.uuid4())[:8])
    name: str
    description: str
    budgetMinutes: int = 180
    status: TaskStatus = TaskStatus.CONFIGURING
    progress: float = 0.0
    elapsed: int = 0
    metrics: TaskMetrics = Field(default_factory=TaskMetrics)
    research_plan: ResearchPlan | None = None
    createdAt: int = Field(
        default_factory=lambda: int(datetime.now().timestamp() * 1000)
    )
    updatedAt: int = Field(
        default_factory=lambda: int(datetime.now().timestamp() * 1000)
    )
    config: dict[str, Any] = Field(default_factory=dict)
